---
layout: post
title: "End device 에서 Vitis 의 기본적인 사용법"
author: "Yonghwan Kwon"
tags: "tools"
comments: true
excerpt_separator: <!--more-->
---
ASIC 까지 진행하지 않고 FPGA 단계에서만 설계를 하는 semi-custom 의 경우 system level 에서의 하드웨어 설계가 주된 목표가 된다. 그럼에도 불구하고, FPGA 에 목표로 하는 시스템을 올리고 검증하기 위해서는 보드가 지원하는 통신 장치를 이용하여 PC 혹은 다른 보드등과의 연결이 필요하다. 물론, PC 에서 검증을 한다면, PC 에 프로그램을 만드는 일도 필요하다. 결국, 목표로 하는 시스템 외에 많은 것들을 설계해야 하는데 우리는 시간이 부족하다. Zynq 로 대표되는 SoC FPGA 의 경우 CPU 와 FPGA 가 함께 보드에 내장되면서 Processing System(PS), Programmabale Logic(PL) 영역을 각각 나누어 처리한다. 이때, 경험적으로 보드에서 외부로 나가는 통신 채널(UART, ETHERNET 등)의 경우 통상적으로 PS 영역에 할당되어 CPU 를 통해 처리하게 된다. 이때, Xilinx 의 Zynq 계열 Chip 들은 Vivado 이외에 Vitis 를 이용하여 C base 코딩을 통해 PS 영역을 컨트롤 한다. 덕분에, 각종 프로토콜을 만족시키기 위한 모듈을 RTL 코딩할 필요가 없어지면서 작업속도가 매우 빨라졌다. SoC FPGA 의 경우 End device 뿐만 아니라 edge computing 혹은 cloud computing 에서도 사용할 수 있으나 이 포스트에서는 end device 에서 사용방법을 다루려고 한다. 간단한 회로를 PL 영역에 만들고, PL 영역과 PS 영역 사이의 통신 그리고, FPGA 와 PC 사이의 UART 통신을 이용하여 FPGA 를 컨트롤 하는 작업을 해보려고 한다. <!--more-->

# 환경
OS : Window 10  
Vivado : 2020.2  
Vitis  : 2020.2  
FPGA   : PYNQ-Z2 (Zybo-z7-10/20 과 하드웨어 구성이 조금 다릅니다.)  

# Hello World
가장 기본이 되는 hello world 부터 시작한다. 다른 툴에 비해서 hello world 까지 과정이 조금 길다. 우선, Vivado 를 열어 Project 를 하나 만들어야 한다.  

![image](https://user-images.githubusercontent.com/120978778/223393344-a0ba504e-0c19-4b94-b9be-2880f44d19c7.png)  

그 다음, Block design 을 하나 만들고, Zynq Processing System 을 추가한다.  

![image](https://user-images.githubusercontent.com/120978778/223393867-91f96d86-3491-49fa-8704-b6dd9009e4a6.png)  

Run Block Automation 을 누른 후 Default 상태에서 OK 를 누른다.  
그 다음, ZYNQ7 Processing System 을 더블클릭 하자.  

![image](https://user-images.githubusercontent.com/120978778/223394181-cd61c0e7-2549-4126-a3dd-5d7868aff8d9.png)  

Zynq 는 상당히 편리한 UI 를 제공한다. 여기서 사용하지 않는 것들을 해제할 것이다.  

**PS-PL Configuration**  
FCLK_RESET0_N 해제  
M AXI GP0 interface 해제  

**Peripheral I/O Pins**  
UART 0 외에 모두 해제  

**Clock Configuration**  
FCLK_CLK0 해제  

OK 를 누르자.  

Regenerate Layout  
Validate Design  

![image](https://user-images.githubusercontent.com/120978778/223395706-9b3d1f9c-d104-46e9-aaad-335026d37152.png)  

사용하지 않는 pin 들이 모두 사라졌고, Validation 결과도 문제없다.  

PS 영역의 경우 Vivado 에서 XDC 파일을 통해 port 를 물려줄 일이 없다. Block Design 저장후 Wrapper 를 씌우고, 바로 Generate Bitstream 을 누르도록 하자.  

성공적으로 Bitstream 이 만들어지면 File - Export - Export Hardware Platform 을 누르도록 하자.  

![image](https://user-images.githubusercontent.com/120978778/223397068-e5362a4c-e95a-4523-aba9-2e169646f5e3.png)  

include bitstream  

특별한 언급이 없는 내용은 전부 Next 해도 좋다. 이제, Hardware Platform 이 Export 되었다. Tools - Launch Vitis IDE  

![image](https://user-images.githubusercontent.com/120978778/223397568-f5fb2869-6f88-4ee8-b57f-96fc3d79e375.png)  

작업 폴더는 vivado 에서 만든 프로젝트와 동일하게 설정하였다.  

Create Platform Project 선택  

![image](https://user-images.githubusercontent.com/120978778/223397820-e6bc1fa6-c550-4a96-9433-2eb3fac6e9c2.png)  

필자는 프로젝트 이름을 Hello_World 로 지정하였다.  

Browse - <프로젝트 경로> \ <비바도에서 Export 한 xsa 파일> - Finish  

![image](https://user-images.githubusercontent.com/120978778/223398324-938d6a26-f8a7-46dc-81c2-6d4bf688d619.png)  

이제 많이 왔다. `Ctrl + B` 를 눌러 빌드를 한 번 해주도록 하자.  

Console 창에 Build Finished 라는 문구가 뜨면 정상적으로 빌드가 된 것이다.  

Explorer 의 Hello_World 프로젝트를 우클릭 - New -  Application Project  

![image](https://user-images.githubusercontent.com/120978778/223398836-f8e0fc98-4266-4e68-8d73-ca2ca9256957.png)  

프로젝트는 만들어졌으니 CPU 에서 처리할 Application 을 만들 것이다. 당연히 여기서는 Hello World 이다.  

Next - Next  

Application 이름은 프로젝트 이름과 다르게 하자. 필자는 Hello_World_app 라고 쓰도록 하겠다.  

Next - Next.  

템플릿에 Hello World 가 이미 있으니 Hello World 를 선택하도록 하자.  

Finish.  

Explorer 를 보면 Hello_World_app_system 이 만들어진 것을 알 수 있다. src 아래 helloworld.c 를 보도록 하자.  

```C++
#include <stdio.h>
#include "platform.h"
#include "xil_printf.h"


int main()
{
    init_platform();

    print("Hello World\n\r");
    print("Successfully ran Hello World application");
    cleanup_platform();
    return 0;
}
```

코드에 대한 설명은 필요하지 않을 것 같다. 다시 빌드를 하자.  

이제 동작을 시킬 것이다. FPGA 를 Jtag 모드에 두고 Power 를 넣어주도록 하자.  

Explorer 에서 Hello_World_app_system 우클릭 - Debug As - Launch Hardware 룰 누르도록 하자.  

Vitis 는 Serial Terminal 을 제공한다. Connect to Serial Port 를 누른 후 장치관리자에서 FPGA 의 UART 컴포넌트를 확인하여 선택하도록 하자. 다른 옵션은 여기서는 선택할 필요 없이 default 값을 쓰면 된다.  

![image](https://user-images.githubusercontent.com/120978778/223401359-3df1ab40-c34e-4716-ab24-4ee75bd5d668.png)  

잘 연결되었다. Clear 로 창을 한 번 지운 후, F8 을 눌러 실행시키자.  

![image](https://user-images.githubusercontent.com/120978778/223401840-50459dc4-32bc-48fa-b60e-47cd5ec46eb6.png)  

Debug 창에서 [System Project Debug] 선택 후 Ctrl + F2 를 눌러 탈출할 수 있다.  

Hello_World 가 꽤 빡세다. 이제부터 본격적인 작업을 진행해 보도록 하자.  

---

# Ring Counter with UART

기본적으로 이 글은 이미 Vivado 를 잘 사용할 수 있고, C/C++ 언어에 익숙한 사람을 대상으로 하고 있다. 만약, 처음으로 구매한 보드가 Zynq 계열이라면 조금 어려울 수도 있겠지만 충분히 따라올 수 있다고 생각한다. 이제, PC 와 보드가 UART 를 통해 통신하고, PC 에서는 set 신호와 Enable 신호를 보낼 수 있다고 가정하자. 보드는 PL 영역에 Ring Counter 를 만들 것이다. 보드의 CPU 는 PC 에서 오는 신호를 받아 set 인 경우 PL 영역에 set 신호를 전달하고, Enable 인 경우 Enable 신호를 전달할 것이다. Ring Counter 는 Enable 신호가 한 번 들어올 때마다 Left shift 를 한 번씩 하도록 만들 것이다.  


---
작성중





